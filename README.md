# üìö API de Gesti√≥n de Usuarios - BCI

Sistema de gesti√≥n de usuarios con autenticaci√≥n JWT y operaciones CRUD completas.

[![Java](https://img.shields.io/badge/Java-21-orange.svg)](https://openjdk.java.net/)
[![Spring Boot](https://img.shields.io/badge/Spring%20Boot-3.5.6-brightgreen.svg)](https://spring.io/projects/spring-boot)

---

## üéØ Descripci√≥n del Proyecto

API RESTful desarrollada con Spring Boot para la gesti√≥n integral de usuarios. Implementa:

- ‚úÖ Registro y autenticaci√≥n de usuarios con JWT
- ‚úÖ Operaciones CRUD completas sobre usuarios
- ‚úÖ Gesti√≥n de m√∫ltiples tel√©fonos por usuario
- ‚úÖ Validaci√≥n de email y contrase√±as con regex configurable
- ‚úÖ Seguridad con Spring Security + BCrypt
- ‚úÖ Documentaci√≥n interactiva con Swagger/OpenAPI
- ‚úÖ Manejo centralizado de excepciones
- ‚úÖ Base de datos H2 en memoria

---

## üîß Stack Tecnol√≥gico

- **Java 21** - Lenguaje base
- **Spring Boot 3.5.6** - Framework principal
- **Spring Data JPA** - Persistencia
- **Spring Security** - Autenticaci√≥n/Autorizaci√≥n
- **H2 Database** - BD en memoria
- **JWT (JJWT 0.11.5)** - Tokens de autenticaci√≥n
- **Lombok** - Reducci√≥n de boilerplate
- **Jakarta Validation** - Validaciones
- **SpringDoc OpenAPI** - Documentaci√≥n
- **JaCoCo** - Cobertura de c√≥digo
- **JUnit 5 + Mockito** - Testing

---

## üèõÔ∏è Arquitectura

### Estructura de Capas

```
com.bci.demo/
‚îú‚îÄ‚îÄ cfg/                    # Configuraciones
‚îÇ   ‚îú‚îÄ‚îÄ security/           # JWT + Spring Security
‚îÇ   ‚îî‚îÄ‚îÄ validation/         # Validadores personalizados
‚îú‚îÄ‚îÄ handlers/               # Manejo global de excepciones
‚îú‚îÄ‚îÄ user/
‚îÇ   ‚îú‚îÄ‚îÄ controller/         # Endpoints REST
‚îÇ   ‚îú‚îÄ‚îÄ service/            # L√≥gica de negocio
‚îÇ   ‚îú‚îÄ‚îÄ repository/         # Acceso a datos (JPA)
‚îÇ   ‚îú‚îÄ‚îÄ entity/             # Entidades (User, Phone)
‚îÇ   ‚îú‚îÄ‚îÄ dto/                # Data Transfer Objects
‚îÇ   ‚îî‚îÄ‚îÄ mapper/             # Conversi√≥n Entity <-> DTO
‚îî‚îÄ‚îÄ DemoApplication.java
```

### Patr√≥n de Dise√±o

- **Arquitectura en Capas**: Controller ‚Üí Service ‚Üí Repository
- **DTO Pattern**: Separaci√≥n entre modelo de datos y API
- **Repository Pattern**: Abstracci√≥n de persistencia
- **Dependency Injection**: IoC de Spring

---

## üì• Instalaci√≥n

### Requisitos

- Java JDK 21+
- Maven 3.8+ (opcional, incluye Maven Wrapper)

### Pasos

1. **Clonar el repositorio**
```bash
git clone https://github.com/crmorenom/demo.git
cd demo
```

2. **Compilar el proyecto**
```bash
# Windows PowerShell
./mvnw clean install
# Windows cmd
mvnw clean install

# Linux/Mac
./mvnw clean install
```

3. **Ejecutar la aplicaci√≥n**


```bash
# Opci√≥n 1: Con Maven
# Windows PowerShell 
./mvnw spring-boot:run
# Windows cmd
mvnw spring-boot:run
# Linux/Mac Con
./mvnw spring-boot:run

# Opci√≥n 2: Con JAR
java -jar target/demo-0.0.1.jar
```

La aplicaci√≥n estar√° disponible en: `http://localhost:8081`

---

## ‚öôÔ∏è Configuraci√≥n

### application.properties

```properties
# Servidor
server.port=8081

# JWT
jwt.secret=bd4f8c2a7f1e9d04b6b5f4c3a2e1d9f7b8a7c6d5e4f3a2b1c0d9e8f7a6b5c4d3
jwt.expiration=3600000  # 1 hora

# H2 Database
spring.h2.console.enabled=true
spring.h2.console.path=/h2-console
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=
spring.jpa.hibernate.ddl-auto=update
spring.h2.console.settings.web-allow-others=true

logging.level.root=INFO
logging.level.org.springframework.web=INFO
server.error.include-stacktrace=always
# Validaci√≥n de Contrase√±a (Regex configurable)
user.password.regex=^(?=.*[A-Z])(?=.*\\d.*\\d)[A-Za-z\\d]{8,12}$
```

### Reglas de Contrase√±a

- ‚úÖ Al menos 1 letra may√∫scula
- ‚úÖ Exactamente 2 n√∫meros
- ‚úÖ Entre 8-12 caracteres
- ‚úÖ Solo letras y n√∫meros

**Ejemplos v√°lidos**: `Hunter22`, `Password12`, `Abc12def`

---

## üì° Endpoints de la API

**Base URL:** `http://localhost:8081/api/users`

### üîì P√∫blicos (Sin JWT)

#### 1. Registrar Usuario
```http
POST /api/users/register
Content-Type: application/json
```
```json
{
    "name": "John Doe",
    "email": "john.doe@example.com",
    "password": "0Password1",
    "phones": [
        {
            "number": "99754553",
            "citycode": "1",
            "countrycode": "57"
        },
        {
            "number": "87654321",
            "citycode": "2",
            "countrycode": "56"
        }
    ]
}
```

**Response 201:**
```json
{
    "codigo": 201,
    "mensaje": "Usuario creado exitosamente",
    "data": {
        "id": "b615f837-d57b-4771-8ec5-8e1ebc7af259",
        "name": "John Doe",
        "email": "john.doe@example.com",
        "created": "2025-10-23T23:20:30.6799404",
        "modified": "2025-10-23T23:20:30.6799404",
        "lastLogin": "2025-10-23T23:20:30.6799404",
        "token": "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJqb2huLmRvZUBleGFtcGxlLmNvbSIsImlhdCI6MTc2MTI3MjQzMCwiZXhwIjoxNzYxMjc2MDMwfQ.TAuk9zA6OqorWDwhwW22ieB5QT7VFKjOUHFI2fdXJ3U",
        "phones": [
            {
                "id": "a117518a-cad8-4598-8f7b-166358e5d45d",
                "number": "99754553",
                "citycode": "1",
                "countrycode": "57"
            },
            {
                "id": "3323eb77-1ca1-4765-bffb-039cf317c69f",
                "number": "87654321",
                "citycode": "2",
                "countrycode": "56"
            }
        ],
        "active": true
    }
}
```

#### 2. Login
```http
POST /api/users/login
Content-Type: application/json
```
```json
{
    "email": "john.doe@example.com",
    "password": "0Password1"
}
```

**Response 200:**
```json
{
    "codigo": 200,
    "mensaje": "Usuario autenticado exitosamente",
    "data": {
        "id": "b615f837-d57b-4771-8ec5-8e1ebc7af259",
        "created": "2025-10-23T23:20:30.67994",
        "modified": "2025-10-23T23:20:30.67994",
        "lastLogin": "2025-10-23T23:20:52.7737512",
        "token": "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJqb2huLmRvZUBleGFtcGxlLmNvbSIsImlhdCI6MTc2MTI3MjQ1MiwiZXhwIjoxNzYxMjc2MDUyfQ.u8H3prqvChetuKCw28lxHj6SwQZmhAec_blgVnkNyCI",
        "isActive": true
    }
}
```

---

### üîí Protegidos (Requieren JWT)

**Header requerido:**
```
Authorization: Bearer {eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJqb2huLmRvZUBleGFtcGxlLmNvbSIsImlhdCI6MTc2MTI3MjQ1MiwiZXhwIjoxNzYxMjc2MDUyfQ.u8H3prqvChetuKCw28lxHj6SwQZmhAec_blgVnkNyCI}
```

#### 3. Obtener Todos los Usuarios
```http
GET /api/users
Authorization: Bearer {eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJqb2huLmRvZUBleGFtcGxlLmNvbSIsImlhdCI6MTc2MTI3MjQ1MiwiZXhwIjoxNzYxMjc2MDUyfQ.u8H3prqvChetuKCw28lxHj6SwQZmhAec_blgVnkNyCI}
```
**Response 200:**
```json
{
    "codigo": 200,
    "mensaje": "Usuarios obtenidos exitosamente",
    "data": [
        {
            "id": "b615f837-d57b-4771-8ec5-8e1ebc7af259",
            "name": "John Doe",
            "email": "john.doe@example.com",
            "created": "2025-10-23T23:20:30.67994",
            "modified": "2025-10-23T23:20:30.67994",
            "lastLogin": "2025-10-23T23:20:52.773751",
            "token": "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJqb2huLmRvZUBleGFtcGxlLmNvbSIsImlhdCI6MTc2MTI3MjQ1MiwiZXhwIjoxNzYxMjc2MDUyfQ.u8H3prqvChetuKCw28lxHj6SwQZmhAec_blgVnkNyCI",
            "phones": [
                {
                    "id": "a117518a-cad8-4598-8f7b-166358e5d45d",
                    "number": "99754553",
                    "citycode": "1",
                    "countrycode": "57"
                },
                {
                    "id": "3323eb77-1ca1-4765-bffb-039cf317c69f",
                    "number": "87654321",
                    "citycode": "2",
                    "countrycode": "56"
                }
            ],
            "active": true
        }
    ]
}
```

#### 4. Obtener Usuario por ID
```http
GET /api/users/{id}
    /api/users/b615f837-d57b-4771-8ec5-8e1ebc7af259

Authorization: Bearer {eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJqb2huLmRvZUBleGFtcGxlLmNvbSIsImlhdCI6MTc2MTI3MjQ1MiwiZXhwIjoxNzYxMjc2MDUyfQ.u8H3prqvChetuKCw28lxHj6SwQZmhAec_blgVnkNyCI}
```

**Response 200:**
```json
{
    "codigo": 200,
    "mensaje": "Usuario obtenido exitosamente",
    "data": {
        "id": "b615f837-d57b-4771-8ec5-8e1ebc7af259",
        "name": "John Doe",
        "email": "john.doe@example.com",
        "created": "2025-10-23T23:20:30.67994",
        "modified": "2025-10-23T23:20:30.67994",
        "lastLogin": "2025-10-23T23:20:52.773751",
        "token": "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJqb2huLmRvZUBleGFtcGxlLmNvbSIsImlhdCI6MTc2MTI3MjQ1MiwiZXhwIjoxNzYxMjc2MDUyfQ.u8H3prqvChetuKCw28lxHj6SwQZmhAec_blgVnkNyCI",
        "phones": [
            {
                "id": "a117518a-cad8-4598-8f7b-166358e5d45d",
                "number": "99754553",
                "citycode": "1",
                "countrycode": "57"
            },
            {
                "id": "3323eb77-1ca1-4765-bffb-039cf317c69f",
                "number": "87654321",
                "citycode": "2",
                "countrycode": "56"
            }
        ],
        "active": true
    }
}
```

#### 5. Actualizar Usuario
```http
PATCH /api/users/{id}
      /api/users/b615f837-d57b-4771-8ec5-8e1ebc7af259

Authorization: Bearer {eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJqb2huLmRvZUBleGFtcGxlLmNvbSIsImlhdCI6MTc2MTI3MjQ1MiwiZXhwIjoxNzYxMjc2MDUyfQ.u8H3prqvChetuKCw28lxHj6SwQZmhAec_blgVnkNyCI}
Content-Type: application/json
```
```json
{
    "name": "John Doe",
    "email": "john.doe@bci.com",
    "password": "0Password7",
    "phones": [
        {
            "id": "a117518a-cad8-4598-8f7b-166358e5d45d",
            "number": "99754553",
            "citycode": "10",
            "countrycode": "60"
        },
        {
            "id": "3323eb77-1ca1-4765-bffb-039cf317c69f",
            "number": "87654321",
            "citycode": "20",
            "countrycode": "90"
        }
    ],
    "active": true
}
```

**Response 200:**
```json
{
    "codigo": 200,
    "mensaje": "Usuario actualizado exitosamente",
    "data": {
        "id": "b615f837-d57b-4771-8ec5-8e1ebc7af259",
        "name": "John Doe",
        "email": "john.doe@bci.com",
        "created": "2025-10-23T23:20:30.67994",
        "modified": "2025-10-23T23:30:30.9958031",
        "lastLogin": "2025-10-23T23:20:52.773751",
        "token": "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJqb2huLmRvZUBiY2kuY29tIiwiaWF0IjoxNzYxMjczMDMxLCJleHAiOjE3NjEyNzY2MzF9.3iSbazEtfmt8RuuEeVDDKdFdK0WIvafKcsjLfUMYXUo",
        "phones": [
            {
                "id": "a117518a-cad8-4598-8f7b-166358e5d45d",
                "number": "99754553",
                "citycode": "10",
                "countrycode": "60"
            },
            {
                "id": "3323eb77-1ca1-4765-bffb-039cf317c69f",
                "number": "87654321",
                "citycode": "20",
                "countrycode": "90"
            }
        ],
        "active": true
    }
}
```

#### 6. Eliminar Usuario
```http
DELETE /api/users/{id}
       /api/users/b615f837-d57b-4771-8ec5-8e1ebc7af259

Authorization: Bearer {eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJqb2huLmRvZUBiY2kuY29tIiwiaWF0IjoxNzYxMjczMDMxLCJleHAiOjE3NjEyNzY2MzF9.3iSbazEtfmt8RuuEeVDDKdFdK0WIvafKcsjLfUMYXUo}
```
**Response 200:**
```json
{
    "codigo": 204,
    "mensaje": "Usuario eliminado exitosamente",
    "data": {
        "id": "b615f837-d57b-4771-8ec5-8e1ebc7af259",
        "name": "John Doe",
        "email": "john.doe@bci.com",
        "created": "2025-10-23T23:20:30.67994",
        "modified": "2025-10-23T23:30:30.995803",
        "lastLogin": "2025-10-23T23:20:52.773751",
        "token": "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJqb2huLmRvZUBiY2kuY29tIiwiaWF0IjoxNzYxMjczMDMxLCJleHAiOjE3NjEyNzY2MzF9.3iSbazEtfmt8RuuEeVDDKdFdK0WIvafKcsjLfUMYXUo",
        "phones": [
            {
                "id": "a117518a-cad8-4598-8f7b-166358e5d45d",
                "number": "99754553",
                "citycode": "10",
                "countrycode": "60"
            },
            {
                "id": "3323eb77-1ca1-4765-bffb-039cf317c69f",
                "number": "87654321",
                "citycode": "20",
                "countrycode": "90"
            }
        ],
        "active": true
    }
}
```

---

## üìä C√≥digos de Respuesta

| C√≥digo | Descripci√≥n |
|--------|-------------|
| 200 | OK - Solicitud exitosa |
| 201 | Created - Usuario registrado |
| 400 | Bad Request - Validaci√≥n fallida |
| 401 | Unauthorized - Token inv√°lido/expirado |
| 404 | Not Found - Usuario no encontrado |
| 409 | Conflict - Email duplicado |
| 500 | Internal Server Error |

---

## üöÄ C√≥mo Probarlo

### Opci√≥n 1: Swagger UI (Recomendado)

1. Inicia la aplicaci√≥n
2. Accede a: `http://localhost:8081/swagger-ui.html`
3. Registra un usuario en `/register`
4. Copia el token del response
5. Click en "Authorize" üîì y pega: `Bearer {token}`
6. Prueba los dem√°s endpoints

![alt text](image-1.png)

### Opci√≥n 2: H2 Console (Ver BD)

1. Accede a: `http://localhost:8081/h2-console`
2. JDBC URL: `jdbc:h2:mem:testdb`
3. User: `sa` | Password: _(vac√≠o)_
4. Ejecuta queries SQL para inspeccionar datos

---

## üìê Diagramas del Proyecto

### Diagrama de Clases (Modelo de Dominio)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ        User             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ-id: UUID                ‚îÇ
‚îÇ-name: String            ‚îÇ
‚îÇ-email: String (unique)  ‚îÇ
‚îÇ-password: String        ‚îÇ
‚îÇ-created: LocalDateTime  ‚îÇ
‚îÇ-modified: LocalDateTime ‚îÇ
‚îÇ-lastLogin: LocalDateTime‚îÇ
‚îÇ-token: String           ‚îÇ
‚îÇ-isActive: Boolean       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ + getPhones(): List     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ 1
           ‚îÇ
           ‚îÇ *
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ        Phone            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ - id: UUID              ‚îÇ
‚îÇ - number: String        ‚îÇ
‚îÇ - citycode: String      ‚îÇ
‚îÇ - countrycode: String   ‚îÇ
‚îÇ - user: User            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Diagrama de Base de Datos

```sql
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  USERS                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ PK  id           UUID                           ‚îÇ
‚îÇ     name         VARCHAR(100)                   ‚îÇ
‚îÇ UK  email        VARCHAR(100) NOT NULL     IDX  ‚îÇ üîë
‚îÇ     password     VARCHAR(255) NOT NULL          ‚îÇ
‚îÇ     created      TIMESTAMP NOT NULL             ‚îÇ
‚îÇ     modified     TIMESTAMP                      ‚îÇ
‚îÇ     last_login   TIMESTAMP                      ‚îÇ
‚îÇ     token        VARCHAR(500)                   ‚îÇ
‚îÇ     is_active    BOOLEAN NOT NULL           IDX ‚îÇ üîë
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  √çndices:                                       ‚îÇ üîë
‚îÇ    - idx_user_email (email)                     ‚îÇ
‚îÇ    - idx_user_active (is_active)                ‚îÇ
‚îÇ    - idx_user_email_active (email, is_active)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚îÇ 1:N
                   ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 PHONES                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ PK  id           UUID                           ‚îÇ
‚îÇ     number       VARCHAR(20) NOT NULL           ‚îÇ
‚îÇ     citycode     VARCHAR(10)                    ‚îÇ
‚îÇ     countrycode  VARCHAR(10)                    ‚îÇ
‚îÇ FK  user_id      UUID NOT NULL           IDX    ‚îÇ üîë
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  √çndices:                                       ‚îÇ üîë
‚îÇ    - idx_phone_user (user_id)                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Diagrama de Arquitectura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              CLIENT (Browser/Postman)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ HTTP/REST
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         üîí SECURITY LAYER                       ‚îÇ
‚îÇ  JwtAuthenticationFilter ‚Üí SecurityConfig       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         üì° CONTROLLER LAYER                     ‚îÇ
‚îÇ            UserController                       ‚îÇ
‚îÇ  - register()   - login()                       ‚îÇ
‚îÇ  - getAllUsers()  - getUserById()               ‚îÇ
‚îÇ  - patchUser()    - deleteUser()                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         üîß SERVICE LAYER                        ‚îÇ
‚îÇ          UserServiceImpl                        ‚îÇ
‚îÇ  - L√≥gica de negocio                            ‚îÇ
‚îÇ  - Validaciones                                 ‚îÇ
‚îÇ  - Generaci√≥n de JWT                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         üíæ REPOSITORY LAYER                     ‚îÇ
‚îÇ          UserRepository (JPA)                   ‚îÇ
‚îÇ  - findByEmail()                                ‚îÇ
‚îÇ  - save()  - findAll()  - delete()              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         üóÑÔ∏è DATABASE (H2)                        ‚îÇ
‚îÇ   USERS table  ‚Üê1:N‚Üí  PHONES table              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


---

## üíæ Persistencia de Datos

### Base de Datos H2

- **Tipo**: En memoria (se pierde al reiniciar)
- **Modo**: Embedded
- **URL**: `jdbc:h2:mem:testdb`
- **Schema**: Auto-generado por Hibernate (DDL auto)

### Configuraci√≥n JPA

```properties
spring.jpa.hibernate.ddl-auto=update
# Opciones: create, create-drop, update, validate, none
```

### Relaciones

- **User ‚Üê Phone**: OneToMany / ManyToOne
- **Cascade**: ALL (eliminar usuario elimina sus tel√©fonos)
- **Orphan Removal**: true

### √çndices de Base de Datos

Para optimizar el rendimiento, se implementaron los siguientes √≠ndices:

**Tabla USERS:**
- `idx_user_email` - Optimiza b√∫squedas por email (login)
- `idx_user_active` - Filtrado de usuarios activos
- `idx_user_email_active` - √çndice compuesto para login + estado

**Tabla PHONES:**
- `idx_phone_user` - Optimiza joins User ‚Üí Phones

**Beneficios:**
- ‚ö° Consultas de login 10x m√°s r√°pidas
- üöÄ Joins optimizados entre User y Phone
- üìä Preparado para escalar a producci√≥n

### Constraints

- `email`: UNIQUE, NOT NULL, max 100 caracteres
- `password`: NOT NULL
- `isActive`: NOT NULL, default TRUE
- `created`: NOT NULL, no actualizable
- `user_id` en Phone: NOT NULL (foreign key)

---

## üß™ Testing

### Ejecutar Tests

```bash
# Todos los tests
./mvnw test

# Con reporte de cobertura
./mvnw clean test jacoco:report
```

### Ver Reporte de Cobertura

Abrir: `target/site/jacoco/index.html`

### Tests Incluidos

- ‚úÖ `JwtUtilTest` - Generaci√≥n y validaci√≥n de tokens
- ‚úÖ `PasswordValidatorTest` - Validaci√≥n de contrase√±as
- ‚úÖ `UserControllerTest` - Endpoints REST
- ‚úÖ `UserServiceImplTest` - L√≥gica de negocio
- ‚úÖ `UserDetailsServiceImplTest` - Autenticaci√≥n

![alt text](image-2.png)

---

## üìö Documentaci√≥n Adicional

- **Swagger UI**: `http://localhost:8081/swagger-ui.html`
- **OpenAPI JSON**: `http://localhost:8081/v3/api-docs`
- **H2 Console**: `http://localhost:8081/h2-console`

---

## üë®‚Äçüíª Autor

Proyecto desarrollado como evaluaci√≥n t√©cnica para **BCI** - Especialista en Integraci√≥n

**Cristian Moreno Mendoza**
- üìß Email: crmorenom@gmail.com

---

## üìù Notas Importantes

‚ö†Ô∏è **Producci√≥n**: Cambiar `jwt.secret` y usar BD persistente (PostgreSQL/MySQL)

‚ö†Ô∏è **Seguridad**: El proyecto usa H2 y configuraciones de desarrollo. No usar en producci√≥n sin ajustes.

‚úÖ **Extensible**: Arquitectura preparada para agregar m√°s m√≥dulos (productos, √≥rdenes, etc.)
